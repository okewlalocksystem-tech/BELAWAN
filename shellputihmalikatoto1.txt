<?php
// --- ERROR HANDLING AKTIF ---
ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);

session_start();

// Password bcrypt yang sudah di-hash, ganti sesuai password kamu
$secure_password_hash = '$2y$10$x2XoZ2BnfRF0CIUKe9kE9.ub/qTZS09RDaHnglNVLAwIMFeyrZWmC'; // contoh hash

$session_key = 'auth_' . md5($_SERVER['HTTP_HOST']);

function show_login_form($error = '') {
    $error_html = $error ? "<p style='color:red;'>".htmlspecialchars($error)."</p>" : "";
    echo <<<HTML
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Login Required</title>
<style>
    body {
        margin: 0; padding: 0;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        background: #222;
        color: #eee;
        font-family: Arial, sans-serif;
    }
    .login-box {
        background: #333;
        padding: 25px 35px;
        border-radius: 8px;
        box-shadow: 0 0 10px #0f0;
        width: 320px;
        text-align: center;
    }
    input[type=password] {
        width: 100%;
        padding: 10px;
        border: none;
        border-radius: 5px;
        margin: 12px 0;
        font-size: 16px;
    }
    input[type=submit] {
        width: 100%;
        padding: 10px;
        background: #0f0;
        border: none;
        border-radius: 5px;
        color: #000;
        font-weight: bold;
        cursor: pointer;
        font-size: 16px;
        transition: background 0.3s ease;
    }
    input[type=submit]:hover {
        background: #0c0;
    }
</style>
</head>
<body>
<div class="login-box">
    <h2>Login Required</h2>
    <form method="post" action="">
        <input type="password" name="password" placeholder="Enter Password" required autofocus />
        <input type="submit" value="Login" />
    </form>
    {$error_html}
</div>
</body>
</html>
HTML;
    exit;
}

// Proses login
if (!isset($_SESSION[$session_key])) {
    if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['password'])) {
        if (password_verify($_POST['password'], $secure_password_hash)) {
            $_SESSION[$session_key] = true;
            header('Location: ' . $_SERVER['PHP_SELF']);
            exit;
        } else {
            show_login_form('Password salah!');
        }
    } else {
        show_login_form();
    }
}

// Setelah login berhasil, tampilkan halaman file manager

$currentDir = isset($_GET['dir']) ? realpath($_GET['dir']) : realpath(__DIR__);
if ($currentDir === false) $currentDir = realpath(__DIR__);

// Batasi supaya tidak bisa keluar dari root folder (folder script)
$rootDir = realpath(__DIR__);
if (strpos($currentDir, $rootDir) !== 0) {
    $currentDir = $rootDir;
}

// Fungsi bantu untuk membuat breadcrumb navigasi
function buildBreadcrumb($dir, $root) {
    $path = str_replace($root, '', $dir);
    $parts = array_filter(explode(DIRECTORY_SEPARATOR, $path));
    $accum = $root;
    $breadcrumbs = ["<a href='?dir=".urlencode($root)."'>Root</a>"];
    foreach ($parts as $part) {
        $accum .= DIRECTORY_SEPARATOR . $part;
        $breadcrumbs[] = "<a href='?dir=".urlencode($accum)."'>".htmlspecialchars($part)."</a>";
    }
    return implode(" / ", $breadcrumbs);
}

// Handle file upload
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_FILES['uploadFile'])) {
    $upload = $_FILES['uploadFile'];
    if ($upload['error'] === UPLOAD_ERR_OK) {
        $destPath = $currentDir . DIRECTORY_SEPARATOR . basename($upload['name']);
        if (move_uploaded_file($upload['tmp_name'], $destPath)) {
            $uploadMessage = "File berhasil diupload: " . htmlspecialchars(basename($upload['name']));
        } else {
            $uploadMessage = "Gagal memindahkan file.";
        }
    } else {
        $uploadMessage = "Upload gagal dengan kode error: " . $upload['error'];
    }
}

// Handle file delete
if (isset($_GET['delete'])) {
    $fileToDelete = realpath($_GET['delete']);
    if ($fileToDelete && strpos($fileToDelete, $rootDir) === 0 && is_file($fileToDelete)) {
        unlink($fileToDelete);
        $deleteMessage = "File berhasil dihapus.";
    } else {
        $deleteMessage = "File tidak ditemukan atau akses dilarang.";
    }
}

// Handle directory create
if (isset($_POST['newDirName'])) {
    $newDirPath = $currentDir . DIRECTORY_SEPARATOR . basename($_POST['newDirName']);
    if (!file_exists($newDirPath)) {
        mkdir($newDirPath, 0755);
        $dirMessage = "Folder berhasil dibuat.";
    } else {
        $dirMessage = "Folder sudah ada.";
    }
}

// Handle file create
if (isset($_POST['newFileName'])) {
    $newFilePath = $currentDir . DIRECTORY_SEPARATOR . basename($_POST['newFileName']);
    if (!file_exists($newFilePath)) {
        file_put_contents($newFilePath, '');
        $fileCreateMessage = "File berhasil dibuat.";
    } else {
        $fileCreateMessage = "File sudah ada.";
    }
}

// Handle file edit save
if (isset($_POST['editFilePath'], $_POST['fileContent'])) {
    $editPath = realpath($_POST['editFilePath']);
    if ($editPath && strpos($editPath, $rootDir) === 0 && is_file($editPath)) {
        file_put_contents($editPath, $_POST['fileContent']);
        $editMessage = "File berhasil disimpan.";
    } else {
        $editMessage = "File tidak ditemukan atau akses dilarang.";
    }
}

// Jika ada permintaan edit file tampilkan form edit
if (isset($_GET['edit'])) {
    $editFile = realpath($_GET['edit']);
    if ($editFile && strpos($editFile, $rootDir) === 0 && is_file($editFile)) {
        $content = htmlspecialchars(file_get_contents($editFile));
        echo <<<HTML
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Edit File - {$editFile}</title>
<style>
    body { background: #111; color: #eee; font-family: monospace; padding: 20px; }
    textarea { width: 100%; height: 70vh; background: #222; color: #0f0; border: none; padding: 15px; font-size: 16px; font-family: monospace; }
    input[type=submit] { padding: 10px 20px; background: #0f0; border: none; border-radius: 5px; color: #000; cursor: pointer; }
    a { color: #0f0; text-decoration: none; }
</style>
</head>
<body>
<h2>Editing File: {$editFile}</h2>
<form method="post">
    <textarea name="fileContent">{$content}</textarea>
    <input type="hidden" name="editFilePath" value="{$editFile}" />
    <br><br>
    <input type="submit" value="Save Changes" />
</form>
<p><a href="?dir=".urlencode(dirname($editFile)).">Back to Manager</a></p>
</body>
</html>
HTML;
        exit;
    } else {
        echo "File tidak ditemukan atau tidak dapat diedit.";
        exit;
    }
}

?>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Advanced File Manager</title>
<style>
    body {
        background-color: #121212;
        color: #eee;
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 30px;
    }
    h1, h2 {
        color: #4CAF50;
    }
    a {
        color: #4CAF50;
        text-decoration: none;
    }
    a:hover {
        text-decoration: underline;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }
    th, td {
        padding: 12px 10px;
        border-bottom: 1px solid #444;
        text-align: left;
        font-size: 14px;
    }
    th {
        background-color: #222;
    }
    tr:hover {
        background-color: #2a2a2a;
    }
    .btn {
        background-color: #f44336;
        border: none;
        padding: 6px 12px;
        color: white;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        margin-right: 5px;
    }
    .btn:hover {
        background-color: #d32f2f;
    }
    form.inline {
        display: inline-block;
    }
    input[type="text"], input[type="file"] {
        padding: 8px;
        margin: 10px 0;
        border-radius: 5px;
        border: 1px solid #333;
        background: #222;
        color: #eee;
        width: 100%;
        box-sizing: border-box;
    }
    input[type="submit"] {
        background-color: #4CAF50;
        border: none;
        color: white;
        padding: 10px 18px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
        width: 100%;
    }
    input[type="submit"]:hover {
        background-color: #45a049;
    }
    .messages {
        margin: 10px 0;
        color: #0f0;
    }
    .container {
        max-width: 1200px;
        margin: auto;
    }
    .breadcrumbs {
        margin-bottom: 20px;
        font-size: 14px;
        color: #aaa;
    }
</style>
</head>
<body>
<div class="container">
    <h1>Advanced File Manager</h1>

    <div class="breadcrumbs">
        <?= buildBreadcrumb($currentDir, $rootDir) ?>
    </div>

    <?php
    // Messages
    if (!empty($uploadMessage)) echo "<p class='messages'>" . htmlspecialchars($uploadMessage) . "</p>";
    if (!empty($deleteMessage)) echo "<p class='messages'>" . htmlspecialchars($deleteMessage) . "</p>";
    if (!empty($dirMessage)) echo "<p class='messages'>" . htmlspecialchars($dirMessage) . "</p>";
    if (!empty($fileCreateMessage)) echo "<p class='messages'>" . htmlspecialchars($fileCreateMessage) . "</p>";
    if (!empty($editMessage)) echo "<p class='messages'>" . htmlspecialchars($editMessage) . "</p>";
    ?>

    <h2>Manage Files & Directories</h2>

    <!-- Form create directory -->
    <form method="post" style="max-width: 300px; margin-bottom: 10px;">
        <input type="text" name="newDirName" placeholder="New Directory Name" required />
        <input type="submit" value="Create Directory" />
    </form>

    <!-- Form create file -->
    <form method="post" style="max-width: 300px; margin-bottom: 10px;">
        <input type="text" name="newFileName" placeholder="New File Name" required />
        <input type="submit" value="Create File" />
    </form>

    <!-- Form upload file -->
    <form method="post" enctype="multipart/form-data" style="max-width: 400px; margin-bottom: 20px;">
        <input type="file" name="uploadFile" required />
        <input type="submit" value="Upload File" />
    </form>

    <h2>Current Directory: <?= htmlspecialchars($currentDir) ?></h2>

    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Type</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
        <?php
        $items = scandir($currentDir);
        foreach ($items as $item) {
            if ($item === '.' || $item === '..') continue;
            $fullPath = $currentDir . DIRECTORY_SEPARATOR . $item;
            $isDir = is_dir($fullPath);
            echo "<tr>";
            echo "<td>" . ($isDir ? "📁 " : "📄 ") . htmlspecialchars($item) . "</td>";
            echo "<td>" . ($isDir ? "Directory" : "File") . "</td>";
            echo "<td>";
            if (!$isDir) {
                echo "<a href='?dir=".urlencode($currentDir)."&edit=".urlencode($fullPath)."' class='btn'>Edit</a>";
            }
            echo "<a href='?dir=".urlencode($currentDir)."&delete=".urlencode($fullPath)."' class='btn' onclick=\"return confirm('Are you sure want to delete ".htmlspecialchars($item)." ?');\">Delete</a>";
            echo "</td>";
            echo "</tr>";
        }
        ?>
        </tbody>
    </table>

</div>
</body>
</html>
